var apiUrl = "http://localhost:8089/";
const urlString = window.location.search;
const urlParams = new URLSearchParams(urlString);
const collection_id = urlParams.get('collection_id');
const collection_status = urlParams.get('collection_status');
const payment_id = urlParams.get('payment_id');
const status = urlParams.get('status');
const external_reference = urlParams.get('external_reference');
const merchant_order_id = urlParams.get('merchant_order_id');
const preference_id = urlParams.get('preference_id');
const urlWebpage = "";
var brandLogo = "";
validateMail();
function successPetition() {
    $('#loadingModal').modal('show');
    $.ajax({
        url: apiUrl + "orders/success?collection_id=" + collection_id + "&collection_status=" + collection_status + "&payment_id=" + payment_id + "&status=" + status + "&external_reference=" + external_reference + "&merchant_order_id=" + merchant_order_id + "&preference_id=" + preference_id,
    }).done(function (result) {
        $('#loadingModal').modal('hide');
        window.location.href = result;
    }).fail(function (result) {
        alert("Lo sentimos se presento un error en la plataforma, por favor comunicate con nosotros a nuestro Whatsapp +56 9 3955 4162");
    });
}


function validateMail() {
    $.ajax({
        url: apiUrl + "orders/check-mail/" + external_reference,
    }).done(function (result) {
        this.brandLogo = result;
        $("#brand-logo").attr("src", this.brandLogo);
        successPetition();
    }).fail(function (result) {
        if (result.responseText == "NoMail") {
            $('#mailModal').modal('show');
        } else {
            alert("Lo sentimos se presento un error en la plataforma, por favor comunicate con nosotros a nuestro Whatsapp +56 9 3955 4162");
        }
    });
}

function saveEmail() {
    let email = $('#email').val();
    if (email != "" && ValidateEmail(email)) {
        var sendInfo = {
            email: email,
        };
        $('#mailModal').modal('hide');
        $.ajax({
            url: apiUrl + "orders/save-mail/" + external_reference,
            type: "POST",
            dataType: "json",
            data: JSON.stringify(sendInfo),
            headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' }
        }).done(function (result) {
            this.brandLogo = result.message;
            $("#brand-logo").attr("src", this.brandLogo);
            successPetition();
        }).fail(function (result) {
            alert("Lo sentimos se presento un error en la plataforma, por favor comunicate con nosotros a nuestro Whatsapp +56 9 3955 4162");
        });
    } else {
        alert("Ingrese un correo valido!")
    }
}

function ValidateEmail(mail) {
    if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail)) {
        return (true)
    }
    alert("Ingrese un correo valido!")
    return (false)
}